name: Run Features Tests

on:
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Features Cypress tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          spec: cypress/tests/violet_app/features/features.cy.js
          install: false
          config: baseUrl=https://staging.violetgrowth.com
        env:
          SLACK_REPORT_PATH: ${{ github.workspace }}/slack_report.txt
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          DEBUG: "cypress:server:proxy,cypress:server:timers"

      - name: Upload videos
        if: failure()
        id: upload_videos
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos

      - name: Resolve video artifact ID
        if: always()
        id: resolve_artifact
        run: |
          set -e
          ARTIFACT_ID=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
            | jq -r '.artifacts[] | select(.name=="cypress-videos") | .id' | head -n1)
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" = "null" ]; then
            echo "artifact_url=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "artifact_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${ARTIFACT_ID}" >> $GITHUB_OUTPUT

      - name: Post Slack report
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPORT_PATH: ${{ github.workspace }}/slack_report.txt
          ARTIFACT_URL: ${{ steps.resolve_artifact.outputs.artifact_url }}
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -e
          # 1) Make the "GitHub Job:" line a clickable link
          perl -0777 -pe 's~^GitHub Job:.*$~GitHub Job: <'"$GITHUB_RUN_URL"'|Open Job>~m' "$REPORT_PATH" > slack_base.txt

          # 2) Insert either the artifact link or the "Job passed" line after "GitHub Job:"
          if [ -n "$ARTIFACT_URL" ]; then
            perl -0777 -pe 's~^(GitHub Job:.*\n)~$1Artifacts (videos): <'"$ARTIFACT_URL"'|Open>\n~m' slack_base.txt > slack_final.txt
          else
            perl -0777 -pe 's~^(GitHub Job:.*\n)~$1Job passed â€” no artifacts.\n~m' slack_base.txt > slack_final.txt
          fi

          # 3) Post to Slack
          curl -sS -X POST -H "Content-Type: application/json" \
            --data "$(jq -n --rawfile t slack_final.txt '{text:$t}')" \
            "$SLACK_WEBHOOK_URL"
