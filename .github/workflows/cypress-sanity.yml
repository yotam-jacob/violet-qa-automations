name: Run Sanity Tests

on:
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    env:
      CYPRESS_APP_HOST: staging.violetgrowth.com
      CYPRESS_BACKEND_HOST: api.portal.exacti.us
      NPM_CONFIG_LEGACY_PEER_DEPS: "true" # needed for exactius-cypress-tests repo
      CYPRESS_EXTRA_ALLOW_HOSTS: public.tableau.com,online.tableau.com,cdn.violetgrowth.com,storage.googleapis.com,a.clarity.ms,client.crisp.chat,www.google-analytics.com,b7lqhwwc.apicdn.sanity.io,prod-useast-b.online.tableau.com,prod.telemetry.tableausoftware.com,www.googletagmanager.com,www.clarity.ms,scripts.clarity.ms,lh3.googleusercontent.com,kejbdjndbnbjgmefkgdddjlbokphdefk,fonts.gstatic.com,fonts.googleapis.com,d6lttq8hqy2mc.cloudfront.net,cross-domain-cookie-check.netlify.app,client.relay.crisp.chat,app-cdn.clickup.com,accounts.google.com,c.clarity.ms,o.clarity.ms

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run Sanity Cypress test
        run: npx cypress run --browser chrome --spec "cypress/tests/violet_app/sanity/sanity.cy.js"


      - name: Upload videos (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: demo-videos
          path: cypress/videos
          if-no-files-found: ignore

      # - name: Resolve video artifact ID
      #   if: always()
      #   id: resolve_artifact
      #   run: |
      #     set -e
      #     ARTIFACT_ID=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
      #       https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
      #       | jq -r '.artifacts[] | select(.name=="cypress-videos") | .id' | head -n1)
      #     if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" = "null" ]; then
      #       echo "artifact_url=" >> $GITHUB_OUTPUT
      #       exit 0
      #     fi
      #     echo "artifact_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${ARTIFACT_ID}" >> $GITHUB_OUTPUT

      # - name: Post Slack report
      #   if: always()
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     REPORT_PATH: ${{ github.workspace }}/slack_report.txt
      #     ARTIFACT_URL: ${{ steps.resolve_artifact.outputs.artifact_url }}
      #     GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      #   run: |
      #     set -e
      #     # 1) Make the "GitHub Job:" line a clickable link
      #     perl -0777 -pe 's~^GitHub Job:.*$~GitHub Job: <'"$GITHUB_RUN_URL"'|Open Job>~m' "$REPORT_PATH" > slack_base.txt

      #     # 2) Insert either the artifact link or the "Job passed" line after "GitHub Job:"
      #     if [ -n "$ARTIFACT_URL" ]; then
      #       perl -0777 -pe 's~^(GitHub Job:.*\n)~$1Artifacts (videos): <'"$ARTIFACT_URL"'|Open>\n~m' slack_base.txt > slack_final.txt
      #     else
      #       perl -0777 -pe 's~^(GitHub Job:.*\n)~$1Job passed â€” no artifacts.\n~m' slack_base.txt > slack_final.txt
      #     fi

      #     # 3) Post to Slack
      #     curl -sS -X POST -H "Content-Type: application/json" \
      #       --data "$(jq -n --rawfile t slack_final.txt '{text:$t}')" \
      #       "$SLACK_WEBHOOK_URL"