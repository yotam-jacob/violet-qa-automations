name: Run Sanity Tests

on:
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Sanity Cypress tests
        run: |
          npx cypress run \
            --browser chrome \
            --headless \
            --spec "cypress/tests/violet_app/sanity/sanity.cy.js" \
            --config "baseUrl=https://staging.violetgrowth.com,pageLoadTimeout=120000,defaultCommandTimeout=20000,requestTimeout=15000,responseTimeout=30000,retries={runMode:2,openMode:0},numTestsKeptInMemory=0,video=false,viewportWidth=1280,viewportHeight=900" \
            -- \
            --disable-dev-shm-usage \
            --no-sandbox \
            --disable-gpu \
            --disable-setuid-sandbox \
            --disable-infobars \
            --window-size=1280,900
        env:
          SLACK_REPORT_PATH: ${{ github.workspace }}/slack_report.txt
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          DEBUG: "cypress:server:proxy,cypress:server:timers"

      - name: Upload videos
        if: failure()
        id: upload_videos
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos

      - name: Resolve video artifact ID
        if: always()
        id: resolve_artifact
        run: |
          set -e
          ARTIFACT_ID=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
            | jq -r '.artifacts[] | select(.name=="cypress-videos") | .id' | head -n1)
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" = "null" ]; then
