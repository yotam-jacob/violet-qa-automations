name: Run Sanity Tests

on:
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci

      # --- NEW: Warm up & Health Check (HEAD + GET, IPv4, retries) ---
      - name: Warm up & health check
        run: |
          set -e
          URL="https://staging.violetgrowth.com"
          echo "Warming up $URL"
          for i in {1..20}; do
            echo "Attempt $i/20 - HEAD"
            if curl -4 -sS -I --max-time 10 "$URL" | head -n1 | grep -q "200\|204\|301\|302"; then
              echo "HEAD success"
            else
              echo "HEAD not OK, sleeping..."
              sleep 5
              continue
            fi

            echo "Attempt $i/20 - GET"
            if curl -4 -sS --max-time 15 -H 'Cache-Control: no-cache' "$URL/?_e2e=1" > /dev/null; then
              echo "GET success"
              exit 0
            fi
            echo "GET not OK, sleeping..."
            sleep 5
          done
          echo "Health check failed for $URL"
          exit 1

      - name: Run Sanity Cypress tests
        run: |
          npx cypress run \
            --browser chrome \
            --headless \
            --spec "cypress/tests/violet_app/sanity/sanity.cy.js" \
            --config "baseUrl=https://staging.violetgrowth.com,pageLoadTimeout=120000,defaultCommandTimeout=20000,requestTimeout=15000,responseTimeout=30000,retries={runMode:2,openMode:0},numTestsKeptInMemory=0,video=false,viewportWidth=1280,viewportHeight=900" \
            -- \
            --disable-dev-shm-usage \
            --no-sandbox \
            --disable-gpu \
            --disable-setuid-sandbox \
            --disable-infobars \
            --disable-http2 \
            --no-proxy-server \
            --window-size=1280,900 \
            --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
        env:
          SLACK_REPORT_PATH: ${{ github.workspace }}/slack_report.txt
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          DEBUG: "cypress:server:proxy,cypress:server:timers"

      - name: Upload videos
        if: failure()
        id: upload_videos
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos

      - name: Resolve video artifact ID
        if: always()
        id: resolve_artifact
        run: |
          set -e
          ARTIFACT_ID=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
            | jq -r '.artifacts[] | select(.name=="cypress-videos") | .id' | head -n1)
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" = "null" ]; then
            echo "artifact_url=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "artifact_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${ARTIFACT_ID}" >> $GITHUB_OUTPUT

      - name: Post Slack report
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPORT_PATH: ${{ github.workspace }}/slack_report.txt
          ARTIFACT_URL: ${{ steps.resolve_artifact.outputs.artifact_url }}
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -e
          perl -0777 -pe 's~^GitHub Job:.*$~GitHub Job: <'"$GITHUB_RUN_URL"'|Open Job>~m' "$REPORT_PATH" > slack_base.txt
          if [ -n "$ARTIFACT_URL" ]; then
            perl -0777 -pe 's~^(GitHub Job:.*\n)~$1Artifacts (videos): <'"$ARTIFACT_URL"'|Open>\n~m' slack_base.txt > slack_final.txt
          else
            perl -0777 -pe 's~^(GitHub Job:.*\n)~$1Job passed â€” no artifacts.\n~m' slack_base.txt > slack_final.txt
          fi
          curl -sS -X POST -H "Content-Type: application/json" \
            --data "$(jq -n --rawfile t slack_final.txt '{text:$t}')" \
            "$SLACK_WEBHOOK_URL"
